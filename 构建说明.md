# 构建说明

## 一键构建（macOS 上交叉编译 Linux/Windows）

```bash
bash scripts/build_dist.sh
```

说明：构建脚本会先执行 `go generate ./internal/bootstrap`，把初始化资源（`config.exm.json`/`mcp.exm.json` + 内置 skills 最小集合）压缩打包进二进制，供运行时 `--init` 自动释放。

默认产物输出到 `dist/`：

- `dist/agent-linux-amd64`
- `dist/agent-linux-arm64`
- `dist/agent-windows-amd64.exe`
- `dist/agent-windows-arm64.exe`

如果你想改输出目录：

```bash
DIST_DIR=/tmp/agent-dist bash scripts/build_dist.sh
```

## 手动构建（等价命令）

```bash
mkdir -p dist
go generate ./internal/bootstrap
CGO_ENABLED=0 GOOS=linux   GOARCH=amd64 go build -o dist/agent-linux-amd64 ./cmd/agent
CGO_ENABLED=0 GOOS=linux   GOARCH=arm64 go build -o dist/agent-linux-arm64 ./cmd/agent
CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -o dist/agent-windows-amd64.exe ./cmd/agent
CGO_ENABLED=0 GOOS=windows GOARCH=arm64 go build -o dist/agent-windows-arm64.exe ./cmd/agent
```

## 分布式 Master/Slave（WebSocket）

### Master（主控 + TUI）

首次在“只有二进制”的目录启动时，建议先初始化：

```bash
./agent master --init
```

会自动生成 `config.json` / `mcp.json` / `skills/`（内置 skills 最小集合）。然后编辑 `config.json` 填入 `model_config.api_key` 等配置，再启动 Master：

```bash
./agent master --config config.json --listen 0.0.0.0:7788 --ws-path /ws
```

首次启动会自动生成并写回 `config.json` 的 `cluster.secret`（Slave 需要同一份 secret 才能注册）。

可选：启用 Redis presence/route（只影响在线状态/路由，当前仍是单 Master MVP）：

```bash
./agent master --config config.json --listen 0.0.0.0:7788 --ws-path /ws --redis-url redis://127.0.0.1:6379/0
```

### Slave（被调度节点）

可选：先生成一个最小化配置模板（并释放内置 skills）：

```bash
./agent slave --init --config slave-config.json
```

```bash
./agent slave --config slave-config.json --master ws://MASTER_IP:7788/ws --id slave-01 --name build-01 --heartbeat 5s
```
